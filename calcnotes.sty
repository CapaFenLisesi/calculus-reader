\ProvidesPackage{calcnotes}

%% LOAD PACKAGES

% Load AMS-LaTeX packages for math typesetting
\usepackage{amsfonts,amssymb,amsthm}
\usepackage{mathtools}

% Load COntent-Oriented LaTeX for semantic math
\usepackage{cool}

% Load SIUnitX for units handling
\usepackage[per-mode=symbol]{siunitx}

% Load xfrac for nice fractions
\usepackage{xfrac}

% Set up font handling
\usepackage[T1]{fontenc}
\usepackage{microtype}

% Use subfiles for chapter includes
\usepackage{subfiles}

% Use the Libertine font with math extensions
\usepackage{libertine}
\usepackage[libertine]{newtxmath}

% Use the Inconsolata font for monospace
\usepackage{inconsolata}

% Use the "Dutch calligraphic" alphabet from mathalfa
\usepackage[cal=dutchcal]{mathalfa}

% Load the csquotes package for semantic quotation marks
\usepackage{csquotes}

% Load the TikZ package for header design
\usepackage{tikz}

% Load the Asymptote package for figures and diagrams
\usepackage[inline]{asymptote}

% Load the float package for fine-grained control over float placement
\usepackage{float}

% Load the fullwidth package for figures that span the margin
\usepackage{fullwidth}

% Load the booktabs package for professional-looking tables
\usepackage{booktabs}

% Load the listings package for code listings
\usepackage{listings}

% Load the exsheets package for exercises with later solutions
\let\vary\undefined % NewTXMath also defines a \vary command that we don't need but which causes errors
\usepackage{exsheets}

% Load the hyperref package for hyperlinking (MUST BE LAST)
\usepackage{hyperref}

% Load the cleveref package for intelligent cross-referencing (MUST BE AFTER HYPERREF)
\usepackage[capitalize]{cleveref}

%% SET OPTIONS

% Configure listings
\lstset{
  basicstyle=\footnotesize\ttfamily,
  commentstyle=\color{gray},
  numbers=left,
  breaklines=true,
  breakatwhitespace=true,
  numberstyle=\footnotesize,
  stepnumber=2,
  showstringspaces=false,
}

% Configure cleveref
\crefname{lstlisting}{listing}{listings}
\Crefname{lstlisting}{Listing}{Listings}
\crefname{equation}{equation}{equations}

% Configure theorem styles
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{observation}[theorem]{Observation}

\newtheorem*{theorem*}{Theorem}
\newtheorem*{corollary*}{Corollary}
\newtheorem*{lemma*}{lemma}
\newtheorem*{proposition*}{Proposition}
\newtheorem*{observation*}{Observation}

\newtheorem*{motprob}{Problem}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem*{definition*}{Definition}

\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}
\newtheorem*{remark*}{Remark}

\newtheorem{example}[theorem]{Example}
\newtheorem*{example*}{Example}

\newtheorem*{motex}{Motivating example}

\newtheorem{note}[theorem]{Note}
\newtheorem*{note*}{Note}

\newtheorem*{soln}{Solution}

% Use roman d for differentiation and integration
\Style{DSymb=\mathrm{d},DShorten=true,IntegrateDifferentialDSymb=\mathrm{d}}

% Define command for writing differentials
\newcommand*{\diff}[1]{\ensuremath{\COOL@notation@IntegrateDifferentialDSymb #1}}

% Override CoOL's derivative command, which breaks with some font packages
\renewcommand*{\D}[3][]{\ensuremath{\frac{\COOL@notation@DSymb^{#1} {#2}}{\COOL@notation@DSymb {#3}^{#1}}}}

% Define command for antidifferentiation
\newcommand*{\AD}[2]{\D[-1]{#1}{#2}}

% Use fancy paired delimiters
\DeclarePairedDelimiter{\pbrac}{(}{)}
\DeclarePairedDelimiter{\sbrac}{[}{]}
\DeclarePairedDelimiter{\cbrac}{\{}{\}}
\DeclarePairedDelimiter{\floor}{\lfloor}{\rfloor}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}
\DeclarePairedDelimiter{\abs}{\lvert}{\rvert}
\DeclarePairedDelimiter{\norm}{\lVert}{\rVert}

\DeclarePairedDelimiter{\closedint}{[}{]}
\DeclarePairedDelimiter{\openint}{(}{)}

% Add some imperial units
\DeclareSIUnit{\foot}{ft}
\DeclareSIUnit{\inch}{in}
\DeclareSIUnit{\mile}{mi}
\DeclareSIUnit{\gallon}{gal}

% Commands for names of important fields
\newcommand*{\fieldname}[1]{\ensuremath{\mathbf{#1}}}
\newcommand*{\RR}{\fieldname{R}}
\newcommand*{\QQ}{\fieldname{Q}}
\newcommand*{\CC}{\fieldname{C}}

% Area function from integral calculus
\newcommand*{\areafunc}[3]{\ensuremath{A_{{#1},{#2}} \pbrac*{#3}}}

% Environment to switch section to exercise mode
\newenvironment*{exercises}{
  \subsection*{Exercises}
}{
  %
}

% Configure Asymptote plots
\begin{asydef}
  import graph;

  void smallsize() {size(1.5inches,0);}
  void medsize() {size(5.5inches,0);}
  void largesize() {size(7.2inches,0);}

  pen thickplot = linewidth(1);

  pen dashedline = dashed+linewidth(1);

  pen transparency = opacity(0.25);
  pen box1 = blue+transparency;
  pen box2 = green+transparency;
  pen box3 = red+transparency;

  void drawbox(real left, real right, real height, pen fillpen = lightgray)
  {
    path thebox = box((left,0),(right,height));
    filldraw(thebox, fillpen);
  }

  void drawrects(real[][] samplepoints, pen fillpen = lightgray){
    for(real[] rect : samplepoints){
      drawbox(rect[0], rect[1], rect[3], fillpen);
    }
  }

  void drawtests(real[][] samplepoints, pen drawpen = dashed){
    for(real[] rect : samplepoints){
      draw((rect[2], 0) -- (rect[2], rect[3]), drawpen);
    }
  }

  real[][] leftrierects(real f(real), real a, real b, int n)
  {
    real dx = (b-a)/n;
    real[][] rects;
    for(int i=0; i<n; ++i) {
      real left = a + i*dx;
      real right = left + dx;
      real test = left;
      rects[i] = new real[] {left, right, test, f(test)};
    }
    return rects;
  }

  real[][] midrierects(real f(real), real a, real b, int n)
  {
    real dx = (b-a)/n;
    real[][] rects;
    for(int i=0; i<n; ++i) {
      real left = a + i*dx;
      real right = left + dx;
      real mid = (left + right)/2;
      real test = mid;
      rects[i] = new real[] {left, right, test, f(test)};
    }
    return rects;
  }

  real[][] rightrierects(real f(real), real a, real b, int n)
  {
    real dx = (b-a)/n;
    real[][] rects;
    for(int i=0; i<n; ++i) {
      real left = a + i*dx;
      real right = left + dx;
      real test = right;
      rects[i] = new real[] {left, right, test, f(test)};
    }
    return rects;
  }

  void labelxticks(real[] xtickpoints)
  {
    int n = xtickpoints.length;
    for(int i=1; i<n; ++i) {
      string ilabel = (string) i;
      labelx("$x_{"+ilabel+"}$", xtickpoints[i-1]);
    }
  }

  void labelxstarticks(real[] xtickpoints)
  {
    int n = xtickpoints.length;
    for(int i=1; i<=n; ++i) {
      string ilabel = (string) i;
      labelx("$x^{*}_{"+ilabel+"}$", xtickpoints[i-1]);
    }
  }

  void fillbetween(real f(real), real g(real), real a, real b, pen fillpen)
  {
    path uppercurve = graph(f, a, b, operator ..);
    path lowercurve = graph(g, b, a, operator ..);
    fill (uppercurve -- lowercurve -- cycle, fillpen);
  }

  void fillunder(real f(real), real a, real b, pen fillpen)
  {
    real zero(real x) {return 0;}
    fillbetween(f, zero, a, b, fillpen);
  }

  path funcplot(real f(real), real a, real b, pen drawpen = thickplot)
  {
    path fplot = graph(f, a, b, operator ..);
    draw(fplot, drawpen);
    return fplot;
  }

  ticklabel Unlabel(real[] x)
  {
    return new string(real v)
    {
      return "";
    };
  }
\end{asydef}

%% CONFIGURE LAYOUT

% Set up title page
\setlength{\droptitle}{1in}

\newcommand{\subtitle}[1]{\gdef\thesubtitle{#1}}

\definecolor{titlecolor}{gray}{0} % Black title
\newcommand{\titlefont}{\color{titlecolor}\fontsize{3cm}{0cm}\sffamily\bfseries} % Printed in giant bold sans-serif

\definecolor{subtitlecolor}{gray}{0.5} % Gray subtitle
\newcommand{\subtitlefont}{\color{subtitlecolor}\fontsize{3cm}{0cm}\sffamily\itshape} % Printed in giant italic sans-serif
\newcommand{\authorfont}{\fontsize{1cm}{0cm}\sffamily}

\renewcommand{\maketitle}{
  \thispagestyle{empty}
  \vspace*{\stretch{1}}
  \begin{flushright}
    {\titlefont\thetitle}\\[\baselineskip]
    {\subtitlefont\thesubtitle}
  \end{flushright}
  \vspace*{\stretch{2}}
  \begin{flushright}
    {\authorfont\theauthor}
  \end{flushright}
  \vspace*{\stretch{4}}
  \cleardoublepage
}

% Next, we define the part style
\aliaspagestyle{part}{empty} % No page numbers on part pages

\definecolor{partnumbercolor}{gray}{0.9} % Light gray part number
\renewcommand{\partnumfont}{\fontsize{8cm}{0cm}\bfseries} % Printed in giant bold serif face (because Biolinum I looks silly)

\definecolor{parttitlecolor}{gray}{0} % Black part name
\renewcommand{\parttitlefont}{\fontsize{1.5cm}{0cm}\bfseries\sffamily} % Printed in large bold sans-serif

\renewcommand{\printpartname}{} % Suppress internal part printing
\renewcommand{\printpartnum}{} % Suppress internal number printing
%\setlength{\midpartskip}{0pt} % Suppress space before printout

\renewcommand{\printparttitle}[1]{%
  \begin{tikzpicture}%
    \draw[color=partnumbercolor] (0, 0) node { \partnumfont \thepart };%
    \draw[color=parttitlecolor] (0, 0) node { \parttitlefont #1 };%
  \end{tikzpicture}%
}

% Next, we configure the chapter style
\makechapterstyle{calcnotes}{
  \renewcommand*{\chapterheadstart}{} % Don't do anything (like vertical space) before printing chapter heading

  \definecolor{chaptertitlecolor}{gray}{0} % Black chapter title
  \renewcommand*{\chaptitlefont}{\fontsize{1cm}{0cm}\bfseries\sffamily} % Printed in large bold sans-serif

  \definecolor{chapternumbercolor}{gray}{0.8} % Light gray chapter number
  \renewcommand*{\chapnumfont}{\fontsize{4cm}{0cm}\bfseries\sffamily} % Printed in huge bold sans-serif

  \renewcommand*{\printchaptername}{} % Suppress internal chapter name printing
  \renewcommand*{\printchapternum}{} % Suppress internal number printing
  \renewcommand*{\printchaptertitle}[1]{%
    \raggedleft
    \begin{tikzpicture}%
      \ifm@m@And
      \draw[color=chapternumbercolor] (0, 0) node { \chapnumfont \thechapter };
      \fi
      \draw[color=chaptertitlecolor] (1.5cm, 0) node[left] { \chaptitlefont ##1};
    \end{tikzpicture}
  }

  \renewcommand*{\afterchapternum}{}
}

\chapterstyle{calcnotes}

% Next, we configure section headings
\newcommand*{\seccommonfont}{\bfseries\sffamily}
\renewcommand{\secheadstyle}{\huge\seccommonfont}
\renewcommand{\subsecheadstyle}{\Large\seccommonfont}
\renewcommand{\subsubsecheadstyle}{\large\seccommonfont}
\renewcommand{\paraheadstyle}{\normalsize\seccommonfont}
\renewcommand{\subparaheadstyle}{\normalsize\seccommonfont}

% Next, we configure the page style
\copypagestyle{calcnotes}{companion}

\newcommand{\headerfont}{\seccommonfont}
\makeevenhead{calcnotes}{\headerfont\thepage}{}%
                        {\headerfont\leftmark}
\makeoddhead{calcnotes}{\headerfont\rightmark}{}%
                       {\headerfont\thepage}

\pagestyle{calcnotes}

% Memoir only numbers down to sections by default. We need to go deeper.
\setsecnumdepth{subsubsection}

% Add some space to the outer margin for marginalia
\setlrmarginsandblock{1in}{2in}{*}
\checkandfixthelayout

\newlength{\marginwidth}
\setlength{\marginwidth}{1.8in}

\newlength{\mainwidth}
\setlength{\mainwidth}{5.5in}

\newlength{\blockwidth}
\setlength{\blockwidth}{\marginwidth+\mainwidth+\marginparsep}

% Use small font for captions
\captionnamefont{\tiny}
\captiontitlefont{\tiny}

% Configure an environment for full-block things
\newenvironment*{widething}{
  \begin{fullwidth}[width=\blockwidth,outermargin=-\marginwidth]
  }{
  \end{fullwidth}
}

% Configure an environment for full-block figures
\newenvironment*{widefig}[1][htbp]{
  \begin{figure}[{#1}]
    \centering
    \begin{widething}
    }{
    \end{widething}
  \end{figure}
}

\newenvironment*{medfig}[1][hbtp]{
  \begin{figure}[{#1}]
    \centering
  }{
  \end{figure}
}

\newenvironment*{smallfig}{
  \begin{marginfigure}
    \centering
  }{
  \end{marginfigure}
}

% Configure exsheets package
\SetupExSheets{
  % question numbering: »chapter.question«
  % use `ch.se.qu' for »chapter.section.question«
  counter-format = ch.se.qu,
  counter-within = chapter,
  headings = runin-nr,
  use-ref = true,
}
% Adjust the heading so there's are gap between heading and
% the previous paragraph a littler larger than the default:
\DeclareInstance{exsheets-heading}{runin-nr}{default}{
  runin = true ,
  number-post-code = \space ,
  join = { main[r,vc]number[l,vc](0pt,0pt) },
}

% Let memoir set up subfigure stuff
\newsubfloat{figure}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "book/calcnotes.tex"
%%% End: